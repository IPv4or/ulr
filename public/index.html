<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ulr | Pure Scheduling</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .hidden { display: none; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="text-slate-800">

    <!-- NAVIGATION -->
    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
            <a href="#" onclick="navigate('')" class="text-2xl font-bold text-indigo-600 tracking-tighter">ulr.</a>
            <div id="nav-links"></div>
        </div>
    </nav>

    <!-- MAIN CONTAINER -->
    <main id="app" class="max-w-6xl mx-auto px-4 py-8 fade-in min-h-screen"></main>

    <!-- NOTIFICATION TOAST -->
    <div id="toast" class="fixed bottom-5 right-5 bg-slate-900 text-white px-6 py-3 rounded shadow-lg hidden z-50"></div>

    <script>
        // --- STATE & CONFIG ---
        const state = {
            token: localStorage.getItem('ulr_token'),
            user: JSON.parse(localStorage.getItem('ulr_user') || 'null'),
        };
        const API_URL = '/api';

        // --- ROUTER ---
        function navigate(hash) {
            window.location.hash = hash;
            handleRoute();
        }

        window.addEventListener('hashchange', handleRoute);
        window.addEventListener('load', handleRoute);

        function handleRoute() {
            const hash = window.location.hash.slice(1);
            updateNav();

            if (hash === '' || hash === 'home') renderHome();
            else if (hash === 'login') renderLogin();
            else if (hash === 'register') renderRegister();
            else if (hash === 'dashboard') renderDashboard();
            else if (hash.startsWith('book/')) renderPublicBooking(hash.split('/')[1]);
            else renderHome();
        }

        function updateNav() {
            const nav = document.getElementById('nav-links');
            if (state.token) {
                nav.innerHTML = `
                    <button onclick="navigate('dashboard')" class="mr-4 hover:text-indigo-600">Dashboard</button>
                    <button onclick="logout()" class="text-slate-500 hover:text-red-500">Logout</button>
                `;
            } else {
                nav.innerHTML = `
                    <button onclick="navigate('login')" class="mr-4 hover:text-indigo-600">Log In</button>
                    <button onclick="navigate('register')" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Get Started</button>
                `;
            }
        }

        // --- VIEWS ---
        function renderHome() {
            document.getElementById('app').innerHTML = `
                <div class="text-center py-20">
                    <h1 class="text-5xl font-bold mb-6 text-slate-900">Scheduling without the noise.</h1>
                    <p class="text-xl text-slate-600 mb-8 max-w-2xl mx-auto">Open source. Free. Optimized by logic, not buzzwords.</p>
                    <div class="flex justify-center gap-4">
                        <button onclick="navigate('register')" class="bg-slate-900 text-white px-8 py-3 rounded-lg text-lg hover:bg-slate-700 transition">Claim your ulr</button>
                        <button onclick="navigate('login')" class="border border-slate-300 px-8 py-3 rounded-lg text-lg hover:bg-white transition">Log In</button>
                    </div>
                    <div class="mt-20 grid md:grid-cols-3 gap-8 text-left">
                        <div class="p-6 bg-white rounded-xl shadow-sm border border-slate-100">
                            <i class="fa-solid fa-bolt text-indigo-600 text-2xl mb-4"></i>
                            <h3 class="font-bold text-lg">Lightning Fast</h3>
                            <p class="text-slate-500">No loading screens. No bloat. Just pure availability.</p>
                        </div>
                        <div class="p-6 bg-white rounded-xl shadow-sm border border-slate-100">
                            <i class="fa-solid fa-shield-halved text-indigo-600 text-2xl mb-4"></i>
                            <h3 class="font-bold text-lg">Privacy First</h3>
                            <p class="text-slate-500">We don't sell your calendar data. Your schedule is yours.</p>
                        </div>
                        <div class="p-6 bg-white rounded-xl shadow-sm border border-slate-100">
                            <i class="fa-solid fa-wand-magic-sparkles text-indigo-600 text-2xl mb-4"></i>
                            <h3 class="font-bold text-lg">Invisible Optimization</h3>
                            <p class="text-slate-500">Smart logic works in the background to prevent burnout.</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAuthForm(type) {
            const isReg = type === 'register';
            return `
                <div class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-sm border border-slate-100 mt-10">
                    <h2 class="text-2xl font-bold mb-6">${isReg ? 'Create Account' : 'Welcome Back'}</h2>
                    <form onsubmit="${type}(event)">
                        ${isReg ? `<input type="text" id="name" placeholder="Full Name" class="w-full p-3 border rounded mb-4" required>` : ''}
                        ${isReg ? `<input type="text" id="handle" placeholder="Username (e.g. john)" class="w-full p-3 border rounded mb-4" required>` : ''}
                        <input type="email" id="email" placeholder="Email" class="w-full p-3 border rounded mb-4" required>
                        <input type="password" id="password" placeholder="Password" class="w-full p-3 border rounded mb-6" required>
                        <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded hover:bg-indigo-700 font-semibold">
                            ${isReg ? 'Sign Up' : 'Log In'}
                        </button>
                    </form>
                </div>
            `;
        }

        function renderLogin() { document.getElementById('app').innerHTML = renderAuthForm('login'); }
        function renderRegister() { document.getElementById('app').innerHTML = renderAuthForm('register'); }

        async function renderDashboard() {
            if (!state.token) return navigate('login');
            
            try {
                const appointments = await fetchAuth('/dashboard');
                const host = window.location.host;
                const proto = window.location.protocol;
                const bookingLink = `${proto}//${host}/#book/${state.user.handle}`;

                document.getElementById('app').innerHTML = `
                    <div class="grid md:grid-cols-3 gap-8">
                        <div class="md:col-span-1 space-y-6">
                            <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                                <div class="flex items-center gap-3 mb-4">
                                    <div class="w-12 h-12 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center text-xl font-bold">
                                        ${state.user.name.charAt(0).toUpperCase()}
                                    </div>
                                    <div>
                                        <h2 class="font-bold">${state.user.name}</h2>
                                        <p class="text-sm text-slate-500">@${state.user.handle}</p>
                                    </div>
                                </div>
                                <div class="bg-slate-50 p-3 rounded text-sm break-all border border-slate-200 mb-4 cursor-pointer hover:bg-slate-100" onclick="navigator.clipboard.writeText('${bookingLink}'); showToast('Link copied!')">
                                    <i class="fa-regular fa-copy mr-2"></i><span class="font-mono font-bold text-indigo-600">${state.user.handle}</span>
                                </div>
                                <button onclick="optimizeSchedule()" id="opt-btn" class="w-full flex items-center justify-center gap-2 bg-slate-900 text-white py-2 rounded hover:bg-slate-700 text-sm transition">
                                    <i class="fa-solid fa-microchip"></i> Optimize My Schedule
                                </button>
                                <div id="ai-result" class="mt-4 text-sm text-slate-600 hidden p-3 bg-indigo-50 rounded border border-indigo-100">
                                    Analyzing...
                                </div>
                            </div>
                        </div>

                        <div class="md:col-span-2">
                            <h3 class="text-xl font-bold mb-4">Upcoming Appointments</h3>
                            ${appointments.length === 0 ? 
                                `<div class="text-center py-12 bg-white rounded-xl border border-dashed border-slate-300 text-slate-400">No appointments yet. Share your link!</div>` : 
                                `<div class="space-y-4">
                                    ${appointments.map(apt => `
                                        <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm flex justify-between items-center">
                                            <div>
                                                <div class="font-bold text-lg">${new Date(apt.startTime).toLocaleString()}</div>
                                                <div class="text-slate-600"><i class="fa-regular fa-user mr-2"></i>${apt.customerName}</div>
                                                ${apt.notes ? `<div class="text-sm text-slate-400 mt-1">"${apt.notes}"</div>` : ''}
                                            </div>
                                            <div class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-bold">CONFIRMED</div>
                                        </div>
                                    `).join('')}
                                </div>`
                            }
                        </div>
                    </div>
                `;
            } catch (e) {
                console.error(e);
            }
        }

        async function renderPublicBooking(handle) {
            try {
                const res = await fetch(`${API_URL}/p/${handle}`);
                const data = await res.json();
                
                if (!res.ok) return document.getElementById('app').innerHTML = `<div class="text-center mt-20 text-xl">User @${handle} not found</div>`;

                document.getElementById('app').innerHTML = `
                    <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden border border-slate-200 mt-10">
                        <div class="bg-slate-900 p-8 text-center">
                            <h2 class="text-3xl font-bold text-white mb-2">Book with ${data.provider.name}</h2>
                            <p class="text-slate-400">Select a time below</p>
                        </div>
                        <div class="p-8">
                            <form onsubmit="bookAppointment(event, '${data.provider._id}')">
                                <div class="grid md:grid-cols-2 gap-6 mb-6">
                                    <div>
                                        <label class="block text-sm font-bold mb-2">Date & Time</label>
                                        <input type="datetime-local" id="book-time" class="w-full p-3 border rounded bg-slate-50" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-bold mb-2">Your Name</label>
                                        <input type="text" id="book-name" class="w-full p-3 border rounded bg-slate-50" required>
                                    </div>
                                </div>
                                <div class="mb-6">
                                    <label class="block text-sm font-bold mb-2">Email Address</label>
                                    <input type="email" id="book-email" class="w-full p-3 border rounded bg-slate-50" required>
                                </div>
                                <div class="mb-8">
                                    <label class="block text-sm font-bold mb-2">Notes (Optional)</label>
                                    <textarea id="book-notes" class="w-full p-3 border rounded bg-slate-50" rows="3"></textarea>
                                </div>
                                <button type="submit" class="w-full bg-indigo-600 text-white text-lg font-bold py-4 rounded-lg hover:bg-indigo-700 transition">
                                    Confirm Booking
                                </button>
                            </form>
                        </div>
                    </div>
                `;
            } catch (e) {
                console.error(e);
            }
        }

        // --- ACTIONS ---
        async function login(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            const res = await fetch(`${API_URL}/auth/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            const data = await res.json();
            if (res.ok) handleAuthSuccess(data);
            else showToast(data.msg || 'Login failed', true);
        }

        async function register(e) {
            e.preventDefault();
            const name = document.getElementById('name').value;
            const handle = document.getElementById('handle').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            const res = await fetch(`${API_URL}/auth/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, handle, email, password })
            });
            const data = await res.json();
            if (res.ok) handleAuthSuccess(data);
            else showToast(data.msg || 'Registration failed', true);
        }

        function handleAuthSuccess(data) {
            localStorage.setItem('ulr_token', data.token);
            localStorage.setItem('ulr_user', JSON.stringify(data.user));
            state.token = data.token;
            state.user = data.user;
            navigate('dashboard');
        }

        function logout() {
            localStorage.removeItem('ulr_token');
            localStorage.removeItem('ulr_user');
            state.token = null;
            state.user = null;
            navigate('home');
        }

        async function bookAppointment(e, providerId) {
            e.preventDefault();
            const startTime = document.getElementById('book-time').value;
            const customerName = document.getElementById('book-name').value;
            const customerEmail = document.getElementById('book-email').value;
            const notes = document.getElementById('book-notes').value;

            const res = await fetch(`${API_URL}/appointments`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ providerId, startTime, customerName, customerEmail, notes })
            });

            if (res.ok) {
                document.getElementById('app').innerHTML = `
                    <div class="text-center py-20 fade-in">
                        <div class="text-6xl text-green-500 mb-4"><i class="fa-solid fa-check-circle"></i></div>
                        <h2 class="text-3xl font-bold mb-2">Booking Confirmed</h2>
                        <p class="text-slate-600">You're all set.</p>
                        <button onclick="navigate('home')" class="mt-8 underline text-indigo-600">Back to Home</button>
                    </div>
                `;
            } else {
                showToast('Booking failed. Try again.', true);
            }
        }

        async function optimizeSchedule() {
            const btn = document.getElementById('opt-btn');
            const resultArea = document.getElementById('ai-result');
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Crunching Data...';
            resultArea.classList.remove('hidden');
            
            try {
                const res = await fetchAuth('/optimize', 'POST');
                let text = res.suggestion;
                
                try {
                     const parsed = JSON.parse(text);
                     text = `Suggestion: Block out ${parsed.time} on ${parsed.date}. Reason: ${parsed.reason}`;
                } catch(e) {}

                resultArea.innerHTML = `<strong class="text-indigo-700">Optimization:</strong> ${text || 'Schedule looks balanced.'}`;
                btn.innerHTML = '<i class="fa-solid fa-check"></i> Done';
            } catch (e) {
                btn.innerHTML = 'Error';
                resultArea.innerHTML = 'AI Service unavailable. Check API Key.';
            }
        }

        // --- HELPERS ---
        async function fetchAuth(endpoint, method = 'GET', body = null) {
            const options = {
                method,
                headers: {
                    'Authorization': `Bearer ${state.token}`,
                    'Content-Type': 'application/json'
                }
            };
            if (body) options.body = JSON.stringify(body);
            const res = await fetch(`${API_URL}${endpoint}`, options);
            if (res.status === 401) logout();
            return res.json();
        }

        function showToast(msg, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.remove('hidden');
            if (isError) toast.classList.add('bg-red-600');
            else toast.classList.remove('bg-red-600');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }
    </script>
</body>
</html>