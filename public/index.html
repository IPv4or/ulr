<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ulr</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --glass-border: rgba(255, 255, 255, 0.08); --glass-bg: rgba(255, 255, 255, 0.03); --glow: 0 0 20px rgba(124, 58, 237, 0.15); }
        body { font-family: 'Space Grotesk', sans-serif; background-color: #050505; color: #e5e5e5; }
        
        .glass { background: var(--glass-bg); backdrop-filter: blur(10px); border: 1px solid var(--glass-border); }
        .glass-card { background: linear-gradient(145deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.01) 100%); border: 1px solid var(--glass-border); transition: all 0.3s ease; }
        .glass-card:hover { border-color: rgba(255,255,255,0.2); box-shadow: var(--glow); transform: translateY(-2px); }
        .glass-input { background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: white; transition: 0.2s; }
        .glass-input:focus { outline: none; border-color: rgba(124, 58, 237, 0.5); box-shadow: var(--glow); }
        
        .fade-in { animation: fadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .glow-text { text-shadow: 0 0 30px rgba(255,255,255,0.1); }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col selection:bg-purple-500 selection:text-white">

    <!-- NAVIGATION -->
    <nav class="fixed w-full top-0 z-50 glass border-b-0 border-b-white/5">
        <div class="max-w-5xl mx-auto px-6 py-5 flex justify-between items-center">
            <a href="#" onclick="navigate('')" id="nav-logo" class="text-xl font-bold tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-white to-gray-400">ulr.</a>
            <div id="nav-links" class="flex gap-6 text-sm font-medium text-gray-400"></div>
        </div>
    </nav>

    <!-- MAIN -->
    <main id="app" class="flex-grow pt-28 px-6 fade-in max-w-5xl mx-auto w-full pb-20"></main>

    <!-- TOAST -->
    <div id="toast" class="fixed bottom-6 right-6 glass bg-black text-white px-5 py-3 rounded border border-white/10 hidden text-sm font-medium z-50"></div>

    <script>
        const state = {
            token: localStorage.getItem('ulr_token'),
            user: JSON.parse(localStorage.getItem('ulr_user') || 'null'),
        };
        const API_URL = '/api';

        // --- ROUTING ---
        function navigate(hash) { window.location.hash = hash; handleRoute(); }
        window.addEventListener('hashchange', handleRoute);
        window.addEventListener('load', handleRoute);

        function handleRoute() {
            const hash = window.location.hash.slice(1);
            
            // Protect landing page from signed in users
            if ((hash === '' || hash === 'home') && state.token) {
                return navigate('dashboard');
            }

            const logo = document.getElementById('nav-logo');
            if (hash === '' || hash === 'home') logo.classList.add('hidden');
            else logo.classList.remove('hidden');

            updateNav();

            if (hash === '' || hash === 'home') renderHome();
            else if (hash === 'login') renderLogin();
            else if (hash === 'register') renderRegister();
            else if (hash === 'dashboard') renderDashboard();
            else if (hash.startsWith('book/')) renderPublicBooking(hash.split('/')[1]);
            else renderHome();
        }

        function updateNav() {
            const nav = document.getElementById('nav-links');
            if (state.token) {
                nav.innerHTML = `<button onclick="logout()" class="hover:text-white transition">Sign Out</button>`;
            } else {
                nav.innerHTML = `
                    <button onclick="navigate('login')" class="hover:text-white transition">Log In</button>
                    <button onclick="navigate('register')" class="text-white hover:text-purple-400 transition">Get Started</button>
                `;
            }
        }

        // --- VIEWS ---

        function renderHome() {
            document.getElementById('app').innerHTML = `
                <div class="flex flex-col items-center justify-center min-h-[70vh] text-center relative">
                    <div class="absolute inset-0 bg-purple-600 blur-[150px] opacity-10 rounded-full pointer-events-none"></div>
                    
                    <h1 class="text-8xl font-bold mb-4 tracking-tighter text-white glow-text">ulr</h1>
                    <p class="text-xl text-gray-500 mb-10 font-light tracking-wide">an open-source alternative</p>
                    
                    <div class="flex gap-4 z-10">
                        <button onclick="navigate('register')" class="glass bg-white/5 px-8 py-3 rounded-full text-lg font-medium hover:bg-white/10 transition border border-white/10 text-white">
                            Claim your link
                        </button>
                    </div>

                    <div class="mt-24 grid grid-cols-3 gap-8 text-left max-w-4xl w-full opacity-60">
                        <div class="glass p-6 rounded-xl border-white/5">
                            <i class="fa-solid fa-ghost mb-3 text-purple-400"></i>
                            <h3 class="font-bold text-white mb-1">Invisible AI</h3>
                            <p class="text-sm text-gray-400">Optimization happens in the background.</p>
                        </div>
                        <div class="glass p-6 rounded-xl border-white/5">
                            <i class="fa-solid fa-layer-group mb-3 text-purple-400"></i>
                            <h3 class="font-bold text-white mb-1">Multi-Link</h3>
                            <p class="text-sm text-gray-400">Create different links for different needs.</p>
                        </div>
                        <div class="glass p-6 rounded-xl border-white/5">
                            <i class="fa-solid fa-moon mb-3 text-purple-400"></i>
                            <h3 class="font-bold text-white mb-1">Dark Mode</h3>
                            <p class="text-sm text-gray-400">Easy on the eyes, always.</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAuthForm(type) {
            const isReg = type === 'register';
            return `
                <div class="max-w-sm mx-auto mt-20 fade-in">
                    <h2 class="text-3xl font-bold mb-2 text-center text-white">${isReg ? 'Init.' : 'Login.'}</h2>
                    <form onsubmit="${type}(event)" class="space-y-4 mt-8">
                        ${isReg ? `
                        <div>
                            <input type="text" id="userName" placeholder="Your Full Name" class="w-full p-4 rounded-lg glass-input" required>
                        </div>
                        <div>
                            <input type="text" id="scheduleName" placeholder="First Schedule Name (e.g. Work)" class="w-full p-4 rounded-lg glass-input" required>
                        </div>` : ''}
                        
                        <input type="email" id="email" placeholder="Email" class="w-full p-4 rounded-lg glass-input" required>
                        <input type="password" id="password" placeholder="Password" class="w-full p-4 rounded-lg glass-input" required>
                        
                        <button type="submit" class="w-full bg-white text-black py-4 rounded-lg font-bold hover:bg-gray-200 transition">
                            ${isReg ? 'Create Account' : 'Enter'}
                        </button>
                    </form>
                    <div class="text-center mt-6">
                        <button onclick="navigate('${isReg ? 'login' : 'register'}')" class="text-sm text-gray-500 hover:text-white">
                            ${isReg ? 'Have an account?' : 'Need an account?'}
                        </button>
                    </div>
                </div>
            `;
        }
        function renderLogin() { document.getElementById('app').innerHTML = renderAuthForm('login'); }
        function renderRegister() { document.getElementById('app').innerHTML = renderAuthForm('register'); }

        async function renderDashboard() {
            if (!state.token) return navigate('login');
            try {
                const data = await fetchAuth('/dashboard');
                const host = window.location.host;
                const proto = window.location.protocol;

                const schedulesHtml = data.schedules.map(s => `
                    <div class="glass-card p-5 rounded-xl flex justify-between items-center group">
                        <div>
                            <div class="font-bold text-lg text-white mb-1">${s.name}</div>
                            <div class="flex items-center gap-2 cursor-pointer text-gray-500 hover:text-purple-400 transition" 
                                 onclick="navigator.clipboard.writeText('${proto}//${host}/#book/${s.slug}'); showToast('Link Copied')">
                                <i class="fa-solid fa-link text-xs"></i>
                                <span class="font-mono text-xs">/book/${s.slug}</span>
                            </div>
                        </div>
                        <div class="opacity-0 group-hover:opacity-100 transition">
                            <a href="#book/${s.slug}" target="_blank" class="text-xs border border-white/20 px-3 py-1 rounded-full hover:bg-white hover:text-black transition">View</a>
                        </div>
                    </div>
                `).join('');

                const appointmentsHtml = data.appointments.length === 0 ? 
                    `<div class="text-center py-10 text-gray-600 italic">No bookings yet.</div>` :
                    data.appointments.map(apt => `
                        <div class="glass p-4 rounded-lg mb-2 flex justify-between items-center border-l-2 border-l-purple-500">
                            <div>
                                <div class="text-gray-400 text-xs uppercase font-bold mb-1">${apt.scheduleId?.name || 'Meeting'}</div>
                                <div class="text-white font-medium">${new Date(apt.startTime).toLocaleString()}</div>
                                <div class="text-sm text-gray-500">${apt.customerName}</div>
                            </div>
                            <div class="text-right">
                                ${apt.notes ? `<div class="text-xs text-gray-600 max-w-[150px] truncate">"${apt.notes}"</div>` : ''}
                            </div>
                        </div>
                    `).join('');

                document.getElementById('app').innerHTML = `
                    <div class="grid md:grid-cols-12 gap-10">
                        <div class="md:col-span-5 space-y-6">
                            <div class="flex justify-between items-end">
                                <div>
                                    <h2 class="text-2xl font-bold text-white">Your Links</h2>
                                    <p class="text-sm text-gray-500">Hello, ${state.user.name}</p>
                                </div>
                                <button onclick="createSchedule()" class="text-xs text-purple-400 hover:text-white transition">+ New</button>
                            </div>
                            <div class="space-y-3">
                                ${schedulesHtml}
                            </div>
                            
                            <div class="mt-10 pt-10 border-t border-white/5">
                                <button onclick="optimizeSchedule()" id="opt-btn" class="w-full glass py-3 rounded-lg text-sm text-gray-400 hover:text-white hover:border-purple-500/30 transition flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-microchip"></i> Run Invisible Optimization
                                </button>
                                <div id="ai-result" class="hidden mt-4 text-xs p-4 bg-purple-900/10 border border-purple-500/20 text-purple-300 rounded-lg leading-relaxed"></div>
                            </div>
                        </div>

                        <div class="md:col-span-7">
                            <h2 class="text-2xl font-bold text-white mb-6">Incoming</h2>
                            ${appointmentsHtml}
                        </div>
                    </div>
                `;
            } catch (e) { console.error(e); }
        }

        async function renderPublicBooking(slug) {
            try {
                const res = await fetch(`${API_URL}/p/${slug}`);
                const data = await res.json();
                if (!res.ok) return document.getElementById('app').innerHTML = `<div class="text-center mt-20 text-gray-500">Link invalid.</div>`;

                document.getElementById('app').innerHTML = `
                    <div class="max-w-lg mx-auto mt-10">
                        <div class="text-center mb-10">
                            <div class="text-purple-500 text-sm font-bold uppercase tracking-widest mb-2">Book your</div>
                            <h2 class="text-4xl font-bold text-white">${data.schedule.name}</h2>
                            <p class="text-gray-500 mt-2">with <span class="text-white font-bold">${data.provider.name}</span></p>
                        </div>
                        
                        <div class="glass p-8 rounded-2xl border-white/5 shadow-2xl">
                            <form onsubmit="bookAppointment(event, '${data.schedule._id}', '${data.provider._id}')" class="space-y-6">
                                
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-3">Date & Time</label>
                                    <div class="flex gap-2">
                                        <input type="number" id="mm" placeholder="MM" min="1" max="12" class="w-1/5 p-3 rounded glass-input text-center text-lg" required>
                                        <input type="number" id="dd" placeholder="DD" min="1" max="31" class="w-1/5 p-3 rounded glass-input text-center text-lg" required>
                                        <input type="number" id="yyyy" placeholder="YYYY" min="2024" max="2030" class="w-1/4 p-3 rounded glass-input text-center text-lg" required>
                                        <span class="flex items-center text-gray-600">@</span>
                                        <input type="number" id="hh" placeholder="HH" min="0" max="23" class="w-1/5 p-3 rounded glass-input text-center text-lg" required>
                                        <input type="number" id="min" placeholder="MM" min="0" max="59" step="15" class="w-1/5 p-3 rounded glass-input text-center text-lg" required>
                                    </div>
                                    <p class="text-xs text-gray-600 mt-2 text-center">Format: 24-Hour Time</p>
                                </div>

                                <div class="grid grid-cols-2 gap-4">
                                    <input type="text" id="book-name" placeholder="Your Name" class="w-full p-4 rounded-lg glass-input" required>
                                    <input type="email" id="book-email" placeholder="Your Email" class="w-full p-4 rounded-lg glass-input" required>
                                </div>
                                <textarea id="book-notes" placeholder="Notes..." class="w-full p-4 rounded-lg glass-input" rows="2"></textarea>
                                
                                <button type="submit" class="w-full bg-white text-black py-4 rounded-lg font-bold hover:bg-purple-100 transition mt-4">
                                    Confirm
                                </button>
                            </form>
                        </div>
                    </div>
                `;
                
                const now = new Date();
                document.getElementById('mm').value = now.getMonth() + 1;
                document.getElementById('dd').value = now.getDate();
                document.getElementById('yyyy').value = now.getFullYear();
                
            } catch (e) { console.error(e); }
        }

        // --- ACTIONS ---

        async function createSchedule() {
            const name = prompt("Name your new schedule (e.g. 'Consultation'):");
            if (!name) return;
            await fetchAuth('/schedules', 'POST', { name });
            renderDashboard();
        }

        async function bookAppointment(e, scheduleId, providerId) {
            e.preventDefault();
            
            const mm = document.getElementById('mm').value.padStart(2, '0');
            const dd = document.getElementById('dd').value.padStart(2, '0');
            const yyyy = document.getElementById('yyyy').value;
            const hh = document.getElementById('hh').value.padStart(2, '0');
            const min = document.getElementById('min').value.padStart(2, '0');
            
            const dateString = `${yyyy}-${mm}-${dd}T${hh}:${min}:00`;
            const startTime = new Date(dateString);

            if (isNaN(startTime.getTime())) return showToast('Invalid Date');

            const res = await fetch(`${API_URL}/appointments`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    scheduleId, 
                    providerId, 
                    startTime, 
                    customerName: document.getElementById('book-name').value, 
                    customerEmail: document.getElementById('book-email').value, 
                    notes: document.getElementById('book-notes').value 
                })
            });

            if (res.ok) {
                document.getElementById('app').innerHTML = `
                    <div class="text-center py-24 fade-in">
                        <h2 class="text-4xl font-bold text-white mb-2">Confirmed.</h2>
                        <p class="text-gray-500">You're on the list.</p>
                        <button onclick="navigate('home')" class="mt-8 text-purple-400 hover:text-white text-sm">Create your own ulr</button>
                    </div>
                `;
            } else { showToast('Booking failed'); }
        }

        async function login(e) {
            e.preventDefault();
            const res = await fetch(`${API_URL}/auth/login`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ email: document.getElementById('email').value, password: document.getElementById('password').value })
            });
            const data = await res.json();
            if (res.ok) handleAuth(data);
            else showToast('Login failed');
        }

        async function register(e) {
            e.preventDefault();
            const res = await fetch(`${API_URL}/auth/register`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    name: document.getElementById('userName').value, // Send Real Name
                    scheduleName: document.getElementById('scheduleName').value, // Send First Schedule
                    email: document.getElementById('email').value, 
                    password: document.getElementById('password').value 
                })
            });
            const data = await res.json();
            if (res.ok) handleAuth(data);
            else showToast('Failed');
        }

        function handleAuth(data) {
            localStorage.setItem('ulr_token', data.token);
            localStorage.setItem('ulr_user', JSON.stringify(data.user));
            state.token = data.token; state.user = data.user;
            navigate('dashboard');
        }

        async function optimizeSchedule() {
            const btn = document.getElementById('opt-btn');
            const resArea = document.getElementById('ai-result');
            btn.innerHTML = 'Thinking...';
            try {
                const res = await fetchAuth('/optimize', 'POST');
                let txt = res.suggestion;
                try { 
                    const p = JSON.parse(txt); 
                    txt = `<strong>Block:</strong> ${p.date} @ ${p.time}<br><strong>Reason:</strong> ${p.reason}`;
                } catch(e){}
                resArea.classList.remove('hidden');
                resArea.innerHTML = txt;
                btn.innerHTML = 'Optimized';
            } catch(e) { btn.innerHTML = 'Error'; }
        }

        function logout() {
            localStorage.clear();
            state.token = null; state.user = null;
            navigate('home');
        }

        async function fetchAuth(url, method='GET', body=null) {
            const opts = { method, headers: { 'Authorization': `Bearer ${state.token}`, 'Content-Type': 'application/json' } };
            if(body) opts.body = JSON.stringify(body);
            return (await fetch(API_URL+url, opts)).json();
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg; t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 3000);
        }
    </script>
</body>
</html>