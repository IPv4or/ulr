<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ulr</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #FAFAFA; color: #171717; }
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .glass-nav { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .input-clean { transition: all 0.2s; border: 1px solid #E5E5E5; }
        .input-clean:focus { border-color: #000; outline: none; box-shadow: 0 0 0 2px rgba(0,0,0,0.05); }
        .btn-black { background: #000; color: #fff; transition: all 0.2s; }
        .btn-black:hover { opacity: 0.8; }
    </style>
</head>
<body class="antialiased">

    <!-- NAVIGATION -->
    <nav class="glass-nav fixed w-full top-0 z-50">
        <div class="max-w-4xl mx-auto px-6 py-4 flex justify-between items-center">
            <a href="#" onclick="navigate('')" class="text-xl font-bold tracking-tight">ulr.</a>
            <div id="nav-links" class="flex gap-4 text-sm font-medium"></div>
        </div>
    </nav>

    <!-- MAIN CONTAINER -->
    <main id="app" class="max-w-4xl mx-auto px-6 py-24 fade-in min-h-screen"></main>

    <!-- TOAST -->
    <div id="toast" class="fixed bottom-6 right-6 bg-black text-white px-5 py-3 rounded-md shadow-xl hidden text-sm font-medium z-50 transition-opacity"></div>

    <script>
        // --- STATE ---
        const state = {
            token: localStorage.getItem('ulr_token'),
            user: JSON.parse(localStorage.getItem('ulr_user') || 'null'),
        };
        const API_URL = '/api';

        // --- ROUTER ---
        function navigate(hash) {
            window.location.hash = hash;
            handleRoute();
        }

        window.addEventListener('hashchange', handleRoute);
        window.addEventListener('load', handleRoute);

        function handleRoute() {
            const hash = window.location.hash.slice(1);
            updateNav();

            if (hash === '' || hash === 'home') renderHome();
            else if (hash === 'login') renderLogin();
            else if (hash === 'register') renderRegister();
            else if (hash === 'dashboard') renderDashboard();
            else if (hash.startsWith('book/')) renderPublicBooking(hash.split('/')[1]);
            else renderHome();
        }

        function updateNav() {
            const nav = document.getElementById('nav-links');
            if (state.token) {
                nav.innerHTML = `
                    <button onclick="logout()" class="text-gray-500 hover:text-black transition">Sign Out</button>
                `;
            } else {
                nav.innerHTML = `
                    <button onclick="navigate('login')" class="text-gray-500 hover:text-black transition">Log In</button>
                    <button onclick="navigate('register')" class="bg-black text-white px-4 py-2 rounded-full hover:opacity-80 transition">Get Started</button>
                `;
            }
        }

        // --- VIEWS ---
        function renderHome() {
            document.getElementById('app').innerHTML = `
                <div class="text-center py-24">
                    <h1 class="text-6xl font-bold mb-6 tracking-tight text-black">Schedule simply.</h1>
                    <p class="text-xl text-gray-500 mb-10 max-w-xl mx-auto font-light">The open-source alternative to complex booking tools. Optimized by invisible logic.</p>
                    <div class="flex justify-center gap-4">
                        <button onclick="navigate('register')" class="bg-black text-white px-8 py-3 rounded-full text-lg font-medium hover:scale-105 transition-transform">Create a Schedule</button>
                    </div>
                </div>
            `;
        }

        function renderAuthForm(type) {
            const isReg = type === 'register';
            return `
                <div class="max-w-sm mx-auto mt-12">
                    <h2 class="text-2xl font-bold mb-2 text-center">${isReg ? 'Create your scheduler' : 'Welcome back'}</h2>
                    <p class="text-center text-gray-400 mb-8 text-sm">${isReg ? 'Free and open source.' : 'Enter your details.'}</p>
                    
                    <form onsubmit="${type}(event)" class="space-y-4">
                        ${isReg ? `
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Schedule Name</label>
                            <input type="text" id="scheduleName" placeholder="e.g. John's Office Hours" class="w-full p-3 rounded-lg bg-white input-clean" required>
                        </div>
                        ` : ''}
                        
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Email</label>
                            <input type="email" id="email" placeholder="you@example.com" class="w-full p-3 rounded-lg bg-white input-clean" required>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Password</label>
                            <input type="password" id="password" placeholder="••••••••" class="w-full p-3 rounded-lg bg-white input-clean" required>
                        </div>
                        
                        <button type="submit" class="w-full btn-black py-3 rounded-lg font-bold mt-4">
                            ${isReg ? 'Continue' : 'Sign In'}
                        </button>
                    </form>
                    <div class="text-center mt-6">
                        <button onclick="navigate('${isReg ? 'login' : 'register'}')" class="text-sm text-gray-400 hover:text-black">
                            ${isReg ? 'Already have an account? Log in' : 'Need an account? Sign up'}
                        </button>
                    </div>
                </div>
            `;
        }

        function renderLogin() { document.getElementById('app').innerHTML = renderAuthForm('login'); }
        function renderRegister() { document.getElementById('app').innerHTML = renderAuthForm('register'); }

        async function renderDashboard() {
            if (!state.token) return navigate('login');
            
            try {
                const appointments = await fetchAuth('/dashboard');
                const host = window.location.host;
                const proto = window.location.protocol;
                const bookingLink = `${proto}//${host}/#book/${state.user.handle}`;

                document.getElementById('app').innerHTML = `
                    <div class="space-y-12">
                        
                        <!-- Header Section -->
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center border-b border-gray-100 pb-8">
                            <div>
                                <h1 class="text-3xl font-bold mb-1">${state.user.name}</h1>
                                <p class="text-gray-400 text-sm">Managed by ulr.</p>
                            </div>
                            <div class="mt-4 md:mt-0">
                                <button onclick="optimizeSchedule()" id="opt-btn" class="text-sm border border-gray-200 bg-white px-4 py-2 rounded-full hover:border-black hover:bg-gray-50 transition flex items-center gap-2">
                                    <i class="fa-solid fa-wand-magic-sparkles text-gray-400"></i> Optimize Schedule
                                </button>
                            </div>
                        </div>

                        <!-- Link Section -->
                        <div class="bg-gray-50 p-6 rounded-xl border border-gray-100">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Your Booking Link</label>
                            <div class="flex gap-2">
                                <input type="text" value="${bookingLink}" readonly class="flex-1 bg-white p-3 rounded-lg border border-gray-200 text-gray-600 font-mono text-sm focus:outline-none">
                                <button onclick="navigator.clipboard.writeText('${bookingLink}'); showToast('Link copied to clipboard')" class="bg-black text-white px-6 rounded-lg font-medium hover:opacity-80">Copy</button>
                            </div>
                        </div>

                        <!-- AI Result Area -->
                        <div id="ai-result" class="hidden p-4 bg-blue-50 text-blue-900 rounded-lg text-sm border border-blue-100"></div>

                        <!-- Appointments List -->
                        <div>
                            <h3 class="text-lg font-bold mb-6">Upcoming</h3>
                            ${appointments.length === 0 ? 
                                `<div class="py-12 text-center text-gray-400 font-light border-t border-gray-100">
                                    No appointments yet. Share your link to get started.
                                </div>` : 
                                `<div class="space-y-0 divide-y divide-gray-100 border-t border-b border-gray-100">
                                    ${appointments.map(apt => `
                                        <div class="py-4 flex justify-between items-center hover:bg-gray-50 transition px-2 -mx-2 rounded-lg group">
                                            <div class="flex items-center gap-4">
                                                <div class="text-center w-12">
                                                    <div class="text-xs font-bold text-gray-400 uppercase">${new Date(apt.startTime).toLocaleString('en-US', {month:'short'})}</div>
                                                    <div class="text-xl font-bold">${new Date(apt.startTime).getDate()}</div>
                                                </div>
                                                <div>
                                                    <div class="font-medium text-gray-900">${new Date(apt.startTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                                                    <div class="text-sm text-gray-500">${apt.customerName}</div>
                                                </div>
                                            </div>
                                            <div class="text-right">
                                                <div class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">Confirmed</div>
                                                ${apt.notes ? `<div class="text-xs text-gray-400 mt-1 max-w-[150px] truncate group-hover:max-w-xs transition-all">${apt.notes}</div>` : ''}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>`
                            }
                        </div>
                    </div>
                `;
            } catch (e) {
                console.error(e);
            }
        }

        async function renderPublicBooking(handle) {
            try {
                const res = await fetch(`${API_URL}/p/${handle}`);
                const data = await res.json();
                
                if (!res.ok) return document.getElementById('app').innerHTML = `<div class="text-center mt-20 text-gray-400">Schedule not found</div>`;

                document.getElementById('app').innerHTML = `
                    <div class="max-w-lg mx-auto mt-12">
                        <div class="mb-8 text-center">
                            <p class="text-gray-400 text-sm uppercase font-bold tracking-widest mb-2">Book a time with</p>
                            <h2 class="text-4xl font-bold">${data.provider.name}</h2>
                        </div>
                        
                        <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100">
                            <form onsubmit="bookAppointment(event, '${data.provider._id}')" class="space-y-5">
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Select Time</label>
                                    <input type="datetime-local" id="book-time" class="w-full p-3 rounded-lg bg-gray-50 input-clean" required>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Your Name</label>
                                        <input type="text" id="book-name" class="w-full p-3 rounded-lg bg-gray-50 input-clean" required>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Your Email</label>
                                        <input type="email" id="book-email" class="w-full p-3 rounded-lg bg-gray-50 input-clean" required>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Notes</label>
                                    <textarea id="book-notes" class="w-full p-3 rounded-lg bg-gray-50 input-clean" rows="2"></textarea>
                                </div>
                                <button type="submit" class="w-full btn-black py-4 rounded-xl font-bold text-lg">
                                    Confirm Booking
                                </button>
                            </form>
                        </div>
                    </div>
                `;
            } catch (e) {
                console.error(e);
            }
        }

        // --- ACTIONS ---
        async function login(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            const res = await fetch(`${API_URL}/auth/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            const data = await res.json();
            if (res.ok) handleAuthSuccess(data);
            else showToast(data.msg || 'Login failed', true);
        }

        async function register(e) {
            e.preventDefault();
            const scheduleName = document.getElementById('scheduleName').value; // Changed
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            const res = await fetch(`${API_URL}/auth/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ scheduleName, email, password }) // Changed
            });
            const data = await res.json();
            if (res.ok) handleAuthSuccess(data);
            else showToast(data.msg || 'Registration failed', true);
        }

        function handleAuthSuccess(data) {
            localStorage.setItem('ulr_token', data.token);
            localStorage.setItem('ulr_user', JSON.stringify(data.user));
            state.token = data.token;
            state.user = data.user;
            navigate('dashboard');
        }

        function logout() {
            localStorage.removeItem('ulr_token');
            localStorage.removeItem('ulr_user');
            state.token = null;
            state.user = null;
            navigate('home');
        }

        async function bookAppointment(e, providerId) {
            e.preventDefault();
            const startTime = document.getElementById('book-time').value;
            const customerName = document.getElementById('book-name').value;
            const customerEmail = document.getElementById('book-email').value;
            const notes = document.getElementById('book-notes').value;

            const res = await fetch(`${API_URL}/appointments`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ providerId, startTime, customerName, customerEmail, notes })
            });

            if (res.ok) {
                document.getElementById('app').innerHTML = `
                    <div class="text-center py-24 fade-in">
                        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-green-100 text-green-600 mb-6 text-2xl"><i class="fa-solid fa-check"></i></div>
                        <h2 class="text-3xl font-bold mb-2">Confirmed</h2>
                        <p class="text-gray-500">You have been added to the schedule.</p>
                        <button onclick="navigate('home')" class="mt-12 text-gray-400 hover:text-black text-sm">Create your own scheduler</button>
                    </div>
                `;
            } else {
                showToast('Booking failed.', true);
            }
        }

        async function optimizeSchedule() {
            const btn = document.getElementById('opt-btn');
            const resultArea = document.getElementById('ai-result');
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i>';
            
            try {
                const res = await fetchAuth('/optimize', 'POST');
                let text = res.suggestion;
                try {
                     const parsed = JSON.parse(text);
                     text = `<strong>Suggestion:</strong> Block out ${parsed.time} on ${parsed.date}. <br><span class="opacity-75">${parsed.reason}</span>`;
                } catch(e) {}

                resultArea.classList.remove('hidden');
                resultArea.innerHTML = text || 'Schedule looks balanced.';
                btn.innerHTML = '<i class="fa-solid fa-check"></i> Optimized';
            } catch (e) {
                btn.innerHTML = 'Error';
            }
        }

        async function fetchAuth(endpoint, method = 'GET', body = null) {
            const options = {
                method,
                headers: {
                    'Authorization': `Bearer ${state.token}`,
                    'Content-Type': 'application/json'
                }
            };
            if (body) options.body = JSON.stringify(body);
            const res = await fetch(`${API_URL}${endpoint}`, options);
            if (res.status === 401) logout();
            return res.json();
        }

        function showToast(msg, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.remove('hidden');
            toast.style.opacity = '1';
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.classList.add('hidden'), 300);
            }, 3000);
        }
    </script>
</body>
</html>